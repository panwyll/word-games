name: Agentic PR loop (CI + Vercel gate)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  check_suite:
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  checks: read

concurrency:
  group: agentic-pr-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number }}
  cancel-in-progress: false

jobs:
  # 1) Your deterministic CI signal in GitHub (fast feedback for the agent)
  build_and_test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
      - run: npm test --if-present

  # 2) Orchestrator: if checks are failing, comment + label to trigger the agent
  orchestrate:
    runs-on: ubuntu-latest
    needs: [build_and_test]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Evaluate status + trigger agent if needed
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get combined status checks for the PR HEAD SHA
            const sha = pr.head.sha;

            // List check runs
            const checks = await github.rest.checks.listForRef({
              owner, repo, ref: sha,
              per_page: 100
            });

            const failing = checks.data.check_runs
              .filter(cr => ['failure', 'cancelled', 'timed_out'].includes(cr.conclusion))
              .map(cr => ({
                name: cr.name,
                conclusion: cr.conclusion,
                details_url: cr.html_url
              }));

            // Also consider "Vercel â€” Deployment" status which sometimes appears as a check run
            // If Vercel posts as a status context instead, we fetch statuses too.
            const statuses = await github.rest.repos.listCommitStatusesForRef({
              owner, repo, ref: sha, per_page: 100
            });

            const failingStatuses = statuses.data
              .filter(s => s.state === 'failure' || s.state === 'error')
              .map(s => ({
                name: s.context,
                state: s.state,
                target_url: s.target_url
              }));

            const allFailing = [...failing.map(f => `- âŒ ${f.name} (${f.conclusion}) ${f.details_url}`),
                                ...failingStatuses.map(s => `- âŒ ${s.name} (${s.state}) ${s.target_url || ''}`)];

            const label = 'needs-agent-fix';

            const hasFailures = allFailing.length > 0;

            // Helper: add/remove label
            async function ensureLabel(on) {
              const labels = await github.rest.issues.listLabelsOnIssue({
                owner, repo, issue_number: pr.number, per_page: 100
              });
              const has = labels.data.some(l => l.name === label);

              if (on && !has) {
                await github.rest.issues.addLabels({
                  owner, repo, issue_number: pr.number, labels: [label]
                });
              }
              if (!on && has) {
                await github.rest.issues.removeLabel({
                  owner, repo, issue_number: pr.number, name: label
                });
              }
            }

            if (hasFailures) {
              await ensureLabel(true);

              const body =
`### ðŸš¨ Checks failing â€” agent fix loop requested

The following required checks are failing on \`${sha.slice(0,7)}\`:

${allFailing.join('\n')}

**Agent instructions**
- Open the failing check(s) above and fix the *first* error.
- Push a commit to this PR branch.
- Repeat until **all required checks are green**, including Vercel.

(Do not ask for merge while any checks are red.)`;

              // Avoid spamming: only comment if last bot comment differs or older
              const comments = await github.rest.issues.listComments({
                owner, repo, issue_number: pr.number, per_page: 50
              });

              const last = comments.data.slice().reverse().find(c => c.user?.type === 'Bot' && (c.body || '').includes('agent fix loop requested'));
              if (!last || (last.body !== body)) {
                await github.rest.issues.createComment({
                  owner, repo, issue_number: pr.number, body
                });
              }
            } else {
              await ensureLabel(false);
              await github.rest.issues.createComment({
                owner, repo, issue_number: pr.number,
                body: `### âœ… All required checks are green\nThis PR is ready for review/merge.`
              });
            }
